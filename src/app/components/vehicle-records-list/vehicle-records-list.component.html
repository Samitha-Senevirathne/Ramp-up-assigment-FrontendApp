
<div class="records-container">
  <h2>Service Records Management</h2>

  <div class="toolbar">
    <button mat-raised-button color="primary" (click)="openCreateDialog()">
      + Add Service Record
    </button>
  </div>

  <!-- Filter Card -->
  <mat-card class="filter-card">
    <mat-card-header>
      <mat-card-title>Filter by Vehicle VIN</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="filter-row">
        <mat-form-field appearance="outline" class="vin-select">
          <mat-label>Select VIN</mat-label>
          <mat-select [(ngModel)]="selectedVIN" (selectionChange)="onVehicleSelect()">
            <mat-option value="">All Vehicles</mat-option>
            <mat-option *ngFor="let v of vehicles" [value]="v.vin">
              {{ v.vin }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <button mat-stroked-button (click)="resetFilter()" *ngIf="selectedVIN">
          Clear Filter
        </button>
      </div>

      <!-- Vehicle Details (if VIN selected) -->
      <div *ngIf="selectedVehicle" class="vehicle-details">
        <h3>Vehicle Information</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <strong>VIN:</strong> {{ selectedVehicle.vin }}
          </div>
          <div class="detail-item">
            <strong>Owner:</strong> {{ selectedVehicle.first_name }} {{ selectedVehicle.last_name }}
          </div>
          <div class="detail-item">
            <strong>Make:</strong> {{ selectedVehicle.car_make }}
          </div>
          <div class="detail-item">
            <strong>Model:</strong> {{ selectedVehicle.car_model }}
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Column Selection Card -->
  <mat-card class="column-card">
    <mat-card-header>
      <mat-card-title>Select Columns to Display</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="column-checkboxes">
        <mat-checkbox
          *ngFor="let col of availableColumns"
          [(ngModel)]="col.checked"
          (change)="updateDisplayedColumns()"
        >
          {{ col.label }}
        </mat-checkbox>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Records Summary -->
  <div class="records-summary">
    <p>
      Showing <strong>{{ records.length }}</strong> service record(s)
      <span *ngIf="selectedVIN"> for VIN: <strong>{{ selectedVIN }}</strong></span>
    </p>
  </div>

  <!-- Service Records Table -->
  <table mat-table [dataSource]="records" class="mat-elevation-z8 full-width-table">
    <!-- VIN Column -->
    <ng-container matColumnDef="vin">
      <th mat-header-cell *matHeaderCellDef>VIN</th>
      <td mat-cell *matCellDef="let r">{{ r.vin }}</td>
    </ng-container>

    <!-- Description Column -->
    <ng-container matColumnDef="description">
      <th mat-header-cell *matHeaderCellDef>Description</th>
      <td mat-cell *matCellDef="let r">{{ r.description }}</td>
    </ng-container>

    <!-- Service Date Column -->
    <ng-container matColumnDef="service_date">
      <th mat-header-cell *matHeaderCellDef>Service Date</th>
      <td mat-cell *matCellDef="let r">{{ r.service_date | date: 'yyyy-MM-dd' }}</td>
    </ng-container>

    <!-- Cost Column -->
    <ng-container matColumnDef="cost">
      <th mat-header-cell *matHeaderCellDef>Cost</th>
      <td mat-cell *matCellDef="let r">{{ r.cost | currency }}</td>
    </ng-container>

    <!-- Actions Column (Always visible) -->
    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef>Actions</th>
      <td mat-cell *matCellDef="let r">
        <button mat-button color="accent" (click)="openEditDialog(r)">Edit</button>
        <button mat-button color="warn" (click)="deleteRecord(r.id)">Delete</button>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
  </table>

  <div *ngIf="records.length === 0" class="no-data">
    <p *ngIf="!selectedVIN">No service records found. Create one to get started!</p>
    <p *ngIf="selectedVIN">No service records found for this vehicle.</p>
  </div>
</div>